<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>X Geocode Targeting Tool</title>
    <script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet" />
    <script src="https://bundle.run/@turf/turf@6.5.0"></script>

    <style>
        :root {
            --primary-blue: #1d9bf0;
            --pos-color: #3b82f6;
            --neg-color: #ef4444;
            --bg-dark: #15202b;
            --sidebar-width: 380px;
            --header-height: 60px;
        }

        /* Base Reset */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: var(--bg-dark); color: white; overflow: hidden; height: 100vh; display: flex; flex-direction: column; }

        /* [AD/WIDGET SLOT] åºƒå‘Šãªã©ã®æŒ¿å…¥ç”¨ */
        .ad-space { display: none; }

        /* Layout */
        header { height: var(--header-height); display: flex; align-items: center; justify-content: space-between; padding: 0 20px; background: rgba(21, 32, 43, 0.9); border-bottom: 1px solid #38444d; z-index: 100; }
        
        #main-container { flex: 1; display: flex; position: relative; overflow: hidden; }
        #map { flex: 1; background: #243447; }

        #sidebar { 
            width: var(--sidebar-width); 
            border-left: 1px solid #38444d; 
            display: flex; 
            flex-direction: column; 
            background: var(--bg-dark);
            z-index: 10;
        }

        /* Components */
        .search-box { position: absolute; top: 15px; left: 15px; z-index: 10; display: flex; gap: 5px; }
        .search-box input { padding: 10px; border-radius: 20px; border: 1px solid #38444d; background: #192734; color: white; width: 250px; }

        .control-panel { padding: 20px; border-bottom: 1px solid #38444d; }
        .mode-selector { display: flex; gap: 10px; margin-bottom: 15px; }
        .btn { cursor: pointer; border: none; padding: 8px 16px; border-radius: 18px; font-weight: bold; transition: 0.2s; }
        .btn-pos { background: var(--pos-color); color: white; }
        .btn-neg { background: var(--neg-color); color: white; }
        .btn-ghost { background: transparent; border: 1px solid #536471; color: white; }
        .btn:disabled { opacity: 0.3; cursor: not-allowed; }

        .circle-list { flex: 1; overflow-y: auto; padding: 10px; }
        .circle-item { background: #192734; border-radius: 8px; padding: 12px; margin-bottom: 10px; border-left: 4px solid gray; position: relative; }
        .circle-item.pos { border-left-color: var(--pos-color); }
        .circle-item.neg { border-left-color: var(--neg-color); }
        .circle-item .remove { position: absolute; top: 10px; right: 10px; cursor: pointer; color: #536471; }

        .output-area { padding: 20px; background: #192734; border-top: 1px solid #38444d; }
        .query-display { background: black; padding: 10px; border-radius: 5px; font-family: monospace; font-size: 12px; word-break: break-all; margin-bottom: 10px; min-height: 60px; border: 1px solid #333; }
        .counter { font-size: 12px; text-align: right; margin-bottom: 5px; }
        .counter.warn { color: #ffd400; font-weight: bold; }
        .counter.limit { color: var(--neg-color); font-weight: bold; }

        /* Debug Overlay */
        #debug-overlay { position: fixed; bottom: 10px; left: 10px; background: rgba(0,0,0,0.8); padding: 10px; font-size: 10px; font-family: monospace; display: none; z-index: 1000; max-width: 300px; border: 1px solid yellow; }

        /* Responsive */
        @media (max-width: 768px) {
            #main-container { flex-direction: column; }
            #sidebar { width: 100%; height: 40%; border-left: none; border-top: 1px solid #38444d; }
            --sidebar-width: 100%;
        }
    </style>
</head>
<body>

<header>
    <div style="font-weight: bold; font-size: 18px;">ğ• Geocode Targeter</div>
    <div style="display: flex; gap: 10px;">
        <button class="btn btn-ghost" onclick="app.undo()" id="undoBtn">â†© æˆ»ã‚‹</button>
        <button class="btn btn-ghost" onclick="app.toggleDebug()">ãƒ‡ãƒãƒƒã‚°</button>
        <button class="btn btn-pos" onclick="app.copyQuery()">ã‚³ãƒ”ãƒ¼</button>
    </div>
</header>

<div id="main-container">
    <div class="search-box">
        <input type="text" id="addressSearch" placeholder="å ´æ‰€ã‚’æ¤œç´¢ (Enterã§ç§»å‹•)..." onkeydown="if(event.key==='Enter') app.searchLocation()">
    </div>
    
    <div id="map"></div>

    <div id="sidebar">
        <div class="control-panel">
            <div class="mode-selector">
                <button class="btn btn-pos" onclick="app.setMode('pos')" id="modePos">ï¼‹ åŠ ç®—(0/4)</button>
                <button class="btn btn-neg" onclick="app.setMode('neg')" id="modeNeg">ï¼ æ¸›ç®—(0/4)</button>
            </div>
            <p style="font-size: 11px; color: #8899a6;">åœ°å›³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦å††ã‚’é…ç½®ã€‚ãƒãƒ³ãƒ‰ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦èª¿æ•´ã€‚</p>
        </div>

        <div class="circle-list" id="circleList">
            </div>

        <div class="output-area">
            <div class="counter" id="charCounter">0 characters / X Limit: 280</div>
            <div class="query-display" id="queryText"></div>
            <div style="display:flex; gap:10px;">
                <button class="btn btn-ghost" style="flex:1" onclick="app.exportJSON()">JSONä¿å­˜</button>
                <button class="btn btn-pos" style="flex:1" onclick="app.openTwitter()">ğ•ã§æ¤œç´¢</button>
            </div>
        </div>
    </div>
</div>

<div id="debug-overlay" id="debugInfo"></div>

<script>
/**
 * [ANALYTICS SLOT]
 * ã“ã“ã«Google Analyticsç­‰ã®è¨ˆæ¸¬ã‚³ãƒ¼ãƒ‰ã‚’æŒ¿å…¥
 */

// I18N configuration
const I18N = {
    ja: { dirtyMsg: "å¤‰æ›´ãŒä¿å­˜ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚é›¢è„±ã—ã¾ã™ã‹ï¼Ÿ", copySuccess: "ã‚¯ã‚¨ãƒªã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼" },
    en: { dirtyMsg: "Unsaved changes. Exit?", copySuccess: "Query copied!" }
};
const lang = navigator.language.startsWith('ja') ? 'ja' : 'en';

class GeocodeApp {
    constructor() {
        this.circles = [];
        this.mode = 'pos';
        this.undoStack = [];
        this.isDirty = false;
        this.isDebug = false;
        this.map = null;
        this.initMap();
        this.bindEvents();
        this.loadState();
    }

    initMap() {
        this.map = new maplibregl.Map({
            container: 'map',
            style: 'https://demotiles.maplibre.org/style.json', // å®Ÿé‹ç”¨ã§ã¯MapLibreæä¾›ã®æ˜ã‚‹ã„ãƒ»æš—ã„ã‚¿ã‚¤ãƒ«æ¨å¥¨
            center: [34.75, 31.5], // Israel
            zoom: 7
        });

        this.map.on('load', () => {
            this.map.addSource('circles-source', { type: 'geojson', data: { type: 'FeatureCollection', features: [] } });
            this.map.addLayer({
                id: 'circles-layer',
                type: 'fill',
                source: 'circles-source',
                paint: {
                    'fill-color': ['get', 'color'],
                    'fill-opacity': 0.3
                }
            });
            this.map.addLayer({
                id: 'circles-outline',
                type: 'line',
                source: 'circles-source',
                paint: {
                    'line-color': ['get', 'color'],
                    'line-width': 2
                }
            });
            this.updateMap();
        });

        this.map.on('click', (e) => {
            this.addCircle(e.lngLat.lat, e.lngLat.lng);
        });
    }

    bindEvents() {
        window.addEventListener('beforeunload', (e) => {
            if (this.isDirty) {
                e.preventDefault();
                e.returnValue = I18N[lang].dirtyMsg;
            }
        });
    }

    setMode(m) {
        this.mode = m;
        document.getElementById('modePos').style.border = m === 'pos' ? '2px solid white' : 'none';
        document.getElementById('modeNeg').style.border = m === 'neg' ? '2px solid white' : 'none';
    }

    // [PERFORMANCE NOTE] Circle generation using Turf.js
    addCircle(lat, lng, radius = 50) {
        const count = this.circles.filter(c => c.type === this.mode).length;
        if (count >= 4) return alert("æœ€å¤§4ã¤ã¾ã§ã§ã™");

        this.saveUndo();
        const id = Date.now().toString();
        this.circles.push({ id, lat, lng, radius, type: this.mode, active: true });
        this.isDirty = true;
        this.updateAll();
    }

    removeCircle(id) {
        this.saveUndo();
        this.circles = this.circles.filter(c => c.id !== id);
        this.updateAll();
    }

    updateAll() {
        this.updateMap();
        this.renderList();
        this.generateQuery();
        this.saveState();
        this.updateCounters();
    }

    updateMap() {
        if (!this.map.getSource('circles-source')) return;
        const features = this.circles.map(c => {
            const circle = turf.circle([c.lng, c.lat], c.radius, { units: 'kilometers' });
            circle.properties = { color: c.type === 'pos' ? '#3b82f6' : '#ef4444', id: c.id };
            return circle;
        });
        this.map.getSource('circles-source').setData({ type: 'FeatureCollection', features });
    }

    renderList() {
        const list = document.getElementById('circleList');
        list.innerHTML = '';
        this.circles.forEach(c => {
            const div = document.createElement('div');
            div.className = `circle-item ${c.type}`;
            div.innerHTML = `
                <div class="remove" onclick="app.removeCircle('${c.id}')">âœ•</div>
                <div style="font-weight:bold; font-size:12px; margin-bottom:5px;">${c.type==='pos'?'åŠ ç®—é ˜åŸŸ':'é™¤å¤–é ˜åŸŸ'}</div>
                <div style="font-size:11px; color:#8899a6;">
                    Lat: ${c.lat.toFixed(4)} Lng: ${c.lng.toFixed(4)}<br>
                    åŠå¾„: <input type="number" value="${c.radius}" style="width:50px; background:transparent; color:white; border:1px solid #38444d" 
                        onchange="app.updateRadius('${c.id}', this.value)"> km
                </div>
            `;
            list.appendChild(div);
        });
        
        document.getElementById('modePos').innerText = `ï¼‹ åŠ ç®—(${this.circles.filter(c=>c.type==='pos').length}/4)`;
        document.getElementById('modeNeg').innerText = `ï¼ æ¸›ç®—(${this.circles.filter(c=>c.type==='neg').length}/4)`;
    }

    updateRadius(id, val) {
        const c = this.circles.find(x => x.id === id);
        if (c) {
            this.saveUndo();
            c.radius = parseFloat(val);
            this.updateAll();
        }
    }

    generateQuery() {
        const pos = this.circles.filter(c => c.type === 'pos').map(c => `geocode:${c.lat.toFixed(5)},${c.lng.toFixed(5)},${c.radius.toFixed(2)}km`);
        const neg = this.circles.filter(c => c.type === 'neg').map(c => `-geocode:${c.lat.toFixed(5)},${c.lng.toFixed(5)},${c.radius.toFixed(2)}km`);
        
        let query = "";
        if (pos.length > 0) {
            query = pos.length > 1 ? `(${pos.join(' OR ')})` : pos[0];
        }
        if (neg.length > 0) {
            query += (query ? " " : "") + neg.join(' ');
        }
        
        const display = document.getElementById('queryText');
        display.innerText = query || "(è¨­å®šãªã—)";
        
        const counter = document.getElementById('charCounter');
        const len = query.length;
        counter.innerText = `${len} characters / X Limit: 280 (500 for Pro)`;
        counter.className = 'counter' + (len > 500 ? ' limit' : (len > 240 ? ' warn' : ''));
    }

    async searchLocation() {
        const query = document.getElementById('addressSearch').value;
        if (!query) return;
        try {
            const res = await fetch(`https://photon.komoot.io/api/?q=${encodeURIComponent(query)}&limit=1`);
            const data = await res.json();
            if (data.features.length > 0) {
                const coord = data.features[0].geometry.coordinates;
                this.map.flyTo({ center: coord, zoom: 10 });
            }
        } catch (e) { console.error("Search error", e); }
    }

    copyQuery() {
        const text = document.getElementById('queryText').innerText;
        navigator.clipboard.writeText(text);
        alert(I18N[lang].copySuccess);
    }

    openTwitter() {
        const text = document.getElementById('queryText').innerText;
        window.open(`https://twitter.com/search?q=${encodeURIComponent(text)}&f=live`, '_blank');
    }

    saveUndo() {
        this.undoStack.push(JSON.stringify(this.circles));
        if (this.undoStack.length > 10) this.undoStack.shift();
    }

    undo() {
        if (this.undoStack.length === 0) return;
        this.circles = JSON.parse(this.undoStack.pop());
        this.updateAll();
    }

    saveState() {
        localStorage.setItem('geo_tool_state', JSON.stringify(this.circles));
    }

    loadState() {
        const saved = localStorage.getItem('geo_tool_state');
        if (saved) {
            this.circles = JSON.parse(saved);
            // wait for map load
            setTimeout(() => this.updateAll(), 1000);
        }
    }

    exportJSON() {
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(this.circles));
        const downloadAnchorNode = document.createElement('a');
        downloadAnchorNode.setAttribute("href", dataStr);
        downloadAnchorNode.setAttribute("download", "x_geocode_config.json");
        document.body.appendChild(downloadAnchorNode);
        downloadAnchorNode.click();
        downloadAnchorNode.remove();
    }

    toggleDebug() {
        this.isDebug = !this.isDebug;
        const panel = document.getElementById('debug-overlay');
        panel.style.display = this.isDebug ? 'block' : 'none';
        if (this.isDebug) {
            setInterval(() => {
                panel.innerText = `DEBUG MODE\nState: ${JSON.stringify(this.circles, null, 2)}\nUndo stack: ${this.undoStack.length}`;
            }, 500);
        }
    }
}

const app = new GeocodeApp();
</script>
</body>
</html>
