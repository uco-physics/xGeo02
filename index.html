<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <title>X(Twitter) Geo-Query Sniper</title>
    <meta name="description" content="Twitterの特定地域検索コマンドを視覚的に生成するプロフェッショナルツール">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://unpkg.com/maplibre-gl@3.x/dist/maplibre-gl.css" rel="stylesheet" />
    <script src="https://unpkg.com/maplibre-gl@3.x/dist/maplibre-gl.js"></script>
    <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

    <style>
        :root { --sidebar-width: 380px; }
        body { overflow: hidden; }
        #map { height: 100vh; width: 100vw; }
        .debug-panel { display: none; background: rgba(0,0,0,0.8); color: #0f0; font-family: monospace; }
        .debug-mode .debug-panel { display: block; }
        
        /* Responsive Layout */
        @media (max-width: 768px) {
            #sidebar { width: 100%; height: 40%; bottom: 0; top: auto; }
            #map { height: 60%; }
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 font-sans">

    <div class="relative flex h-screen overflow-hidden">
        
        <main id="map" class="flex-grow bg-gray-800"></main>

        <aside id="sidebar" class="absolute right-0 top-0 w-[var(--sidebar-width)] h-full bg-gray-900 shadow-2xl flex flex-col border-l border-gray-700 z-10">
            <header class="p-4 border-b border-gray-700 flex justify-between items-center">
                <h1 class="font-bold text-lg"><i class="bi bi-crosshair2 mr-2"></i>Geo-Sniper</h1>
                <div class="flex gap-2">
                    <button id="btn-debug" class="text-xs bg-gray-700 px-2 py-1 rounded hover:bg-gray-600">DEBUG</button>
                    <button id="btn-lang" class="text-xs bg-gray-700 px-2 py-1 rounded">JP/EN</button>
                </div>
            </header>

            <div class="p-4 space-y-4 flex-grow overflow-y-auto">
                <section>
                    <h2 class="text-xs font-semibold text-gray-400 uppercase mb-2">モード選択</h2>
                    <div class="grid grid-cols-2 gap-2">
                        <button id="mode-add" class="bg-blue-600 hover:bg-blue-500 py-2 rounded text-sm font-bold border-2 border-blue-400">
                            <i class="bi bi-plus-circle mr-1"></i> 追加円
                        </button>
                        <button id="mode-subtract" class="bg-gray-800 hover:bg-red-900 py-2 rounded text-sm font-bold border-2 border-transparent hover:border-red-500">
                            <i class="bi bi-dash-circle mr-1"></i> 除外円
                        </button>
                    </div>
                </section>

                <section>
                    <h2 class="text-xs font-semibold text-gray-400 uppercase mb-2">エリアリスト</h2>
                    <div id="fence-list" class="space-y-2">
                        </div>
                </section>
            </div>

            <footer class="p-4 bg-gray-800 border-t border-gray-700">
                <div class="mb-2 flex justify-between items-center">
                    <span class="text-xs font-semibold text-gray-400">TWITTER QUERY</span>
                    <span id="char-count" class="text-xs text-blue-400">0 / 500 chars</span>
                </div>
                <textarea id="query-output" readonly class="w-full bg-black text-green-400 p-2 text-xs rounded border border-gray-600 h-24 mb-3 cursor-text"></textarea>
                <div class="flex gap-2">
                    <button id="btn-copy" class="flex-grow bg-blue-500 hover:bg-blue-600 py-2 rounded font-bold transition">
                        <i class="bi bi-copy mr-2"></i>コピー
                    </button>
                    <button id="btn-x-search" class="bg-white text-black px-4 py-2 rounded font-bold hover:bg-gray-200">
                        <i class="bi bi-twitter-x"></i>
                    </button>
                </div>
            </footer>
        </aside>

        <div id="debug-panel" class="debug-panel absolute bottom-4 left-4 p-4 rounded text-[10px] w-80 max-h-64 overflow-auto z-20 pointer-events-none">
            [DEBUG LOG]<br>
            <pre id="debug-json"></pre>
        </div>

        </div>

    <script>
        /**
         * X-Geo-Sniper Core Application
         * Standard: ES6+, Class-based, SOLID principles
         */
        class GeoSniper {
            constructor() {
                this.state = {
                    fences: [], // { id, lat, lng, radius, type: 'plus'|'minus', active: true }
                    mode: 'plus',
                    isDirty: false,
                    lang: 'ja'
                };
                
                this.CONFIG = {
                    MAX_CHARS: 500,
                    INITIAL_CENTER: [34.7818, 32.0853], // Tel Aviv
                    INITIAL_ZOOM: 7,
                    COLORS: {
                        plus: '#3b82f6',
                        minus: '#ef4444'
                    }
                };

                this.initMap();
                this.bindEvents();
                this.loadFromStorage();
            }

            // --- Initialization ---
            initMap() {
                this.map = new maplibre-gl.Map({
                    container: 'map',
                    style: 'https://demotiles.maplibre.org/style.json', // Vector style
                    center: this.CONFIG.INITIAL_CENTER,
                    zoom: this.CONFIG.INITIAL_ZOOM
                });

                this.map.on('click', (e) => this.handleMapClick(e));
            }

            // --- Core Logic ---
            handleMapClick(e) {
                const { lng, lat } = e.lngLat;
                this.addFence(lat, lng);
            }

            addFence(lat, lng, radius = 50) {
                const newFence = {
                    id: 'f-' + Date.now(),
                    lat: parseFloat(lat.toFixed(5)),
                    lng: parseFloat(lng.toFixed(5)),
                    radius: radius,
                    type: this.state.mode,
                    active: true
                };
                this.state.fences.push(newFence);
                this.markAsDirty();
                this.render();
            }

            removeFence(id) {
                this.state.fences = this.state.fences.filter(f => f.id !== id);
                this.markAsDirty();
                this.render();
            }

            updateFence(id, updates) {
                const fence = this.state.fences.find(f => f.id === id);
                if (fence) Object.assign(fence, updates);
                this.markAsDirty();
                this.render();
            }

            // --- Query Generation ---
            generateQuery() {
                const plusParts = this.state.fences
                    .filter(f => f.active && f.type === 'plus')
                    .map(f => `geocode:${f.lat},${f.lng},${f.radius}km`);

                const minusParts = this.state.fences
                    .filter(f => f.active && f.type === 'minus')
                    .map(f => `-geocode:${f.lat},${f.lng},${f.radius}km`);

                let query = "";
                if (plusParts.length > 1) {
                    query = `(${plusParts.join(' OR ')})`;
                } else if (plusParts.length === 1) {
                    query = plusParts[0];
                }

                if (minusParts.length > 0) {
                    query += (query ? " " : "") + minusParts.join(' ');
                }

                return query;
            }

            // --- UI Rendering ---
            render() {
                this.updateLayers();
                this.updateList();
                
                const query = this.generateQuery();
                document.getElementById('query-output').value = query;
                
                // Character count validation
                const countEl = document.getElementById('char-count');
                const len = query.length;
                countEl.textContent = `${len} / ${this.CONFIG.MAX_CHARS} chars`;
                countEl.className = len > this.CONFIG.MAX_CHARS ? "text-red-500 font-bold" : "text-blue-400";

                // Debug Output
                document.getElementById('debug-json').textContent = JSON.stringify(this.state, null, 2);
                
                this.saveToStorage();
            }

            updateLayers() {
                // Clear existing markers/circles (Simplified approach for Single HTML)
                // In a production app, we would use MapLibre GeoJSON sources for better perf
                this.state.fences.forEach(f => {
                    // This is where Circle drawing logic goes.
                    // For brevity in a single file, we use a robust Source update pattern:
                    const sourceId = `source-${f.id}`;
                    const layerId = `layer-${f.id}`;

                    if (!this.map.getSource(sourceId)) {
                        const circleData = turf.circle([f.lng, f.lat], f.radius, { units: 'kilometers' });
                        this.map.addSource(sourceId, { type: 'geojson', data: circleData });
                        this.map.addLayer({
                            id: layerId,
                            type: 'fill',
                            source: sourceId,
                            paint: {
                                'fill-color': this.CONFIG.COLORS[f.type],
                                'fill-opacity': 0.3,
                                'fill-outline-color': this.CONFIG.COLORS[f.type]
                            }
                        });
                    } else {
                        const circleData = turf.circle([f.lng, f.lat], f.radius, { units: 'kilometers' });
                        this.map.getSource(sourceId).setData(circleData);
                    }
                });

                // Remove deleted layers
                const currentIds = this.state.fences.map(f => `layer-${f.id}`);
                this.map.getStyle().layers.forEach(layer => {
                    if (layer.id.startsWith('layer-') && !currentIds.includes(layer.id)) {
                        this.map.removeLayer(layer.id);
                        this.map.removeSource(layer.id.replace('layer-', 'source-'));
                    }
                });
            }

            updateList() {
                const listEl = document.getElementById('fence-list');
                listEl.innerHTML = this.state.fences.map(f => `
                    <div class="bg-gray-800 p-3 rounded border-l-4 ${f.type === 'plus' ? 'border-blue-500' : 'border-red-500'} flex flex-col gap-2">
                        <div class="flex justify-between items-center text-xs">
                            <span class="font-bold">${f.type === 'plus' ? '追加' : '除外'} エリア</span>
                            <button onclick="app.removeFence('${f.id}')" class="text-gray-400 hover:text-red-400"><i class="bi bi-trash"></i></button>
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <label class="text-[10px] text-gray-500">半径 (km)
                                <input type="number" value="${f.radius}" onchange="app.updateFence('${f.id}', {radius: Number(this.value)})" class="w-full bg-gray-700 rounded px-1 text-white">
                            </label>
                            <label class="text-[10px] text-gray-500">座標
                                <div class="text-white truncate text-[9px] mt-1">${f.lat}, ${f.lng}</div>
                            </label>
                        </div>
                    </div>
                `).join('');
            }

            // --- Browser & Event Integration ---
            bindEvents() {
                document.getElementById('mode-add').addEventListener('click', () => this.setMode('plus'));
                document.getElementById('mode-subtract').addEventListener('click', () => this.setMode('minus'));
                document.getElementById('btn-copy').addEventListener('click', () => this.copyToClipboard());
                document.getElementById('btn-x-search').addEventListener('click', () => this.openTwitter());
                document.getElementById('btn-debug').addEventListener('click', () => document.body.classList.toggle('debug-mode'));
                
                window.addEventListener('beforeunload', (e) => {
                    if (this.state.isDirty) {
                        e.preventDefault();
                        e.returnValue = '';
                    }
                });
            }

            setMode(mode) {
                this.state.mode = mode;
                document.getElementById('mode-add').className = mode === 'plus' ? 'bg-blue-600 border-blue-400 py-2 rounded text-sm font-bold border-2' : 'bg-gray-800 py-2 rounded text-sm font-bold border-2 border-transparent hover:border-blue-500';
                document.getElementById('mode-subtract').className = mode === 'minus' ? 'bg-red-600 border-red-400 py-2 rounded text-sm font-bold border-2' : 'bg-gray-800 py-2 rounded text-sm font-bold border-2 border-transparent hover:border-red-500';
            }

            markAsDirty() { this.state.isDirty = true; }
            
            saveToStorage() {
                localStorage.setItem('geo_sniper_data', JSON.stringify(this.state.fences));
            }

            loadFromStorage() {
                const saved = localStorage.getItem('geo_sniper_data');
                if (saved) {
                    this.state.fences = JSON.parse(saved);
                    // Wait for map load to render
                    this.map.once('load', () => this.render());
                }
            }

            copyToClipboard() {
                const q = document.getElementById('query-output');
                q.select();
                document.execCommand('copy');
                alert('コピーしました！');
            }

            openTwitter() {
                const q = encodeURIComponent(this.generateQuery());
                window.open(`https://twitter.com/search?q=${q}&f=live`, '_blank');
            }
        }

        // Initialize App
        const app = new GeoSniper();
    </script>
</body>
</html>
