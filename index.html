<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>X Geo-Targeting Tool Pro</title>
    <script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet" />
    <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>
    <style>
        :root {
            --primary-blue: #1d9bf0;
            --danger-red: #e0245e;
            --bg-dark: #15202b;
            --sidebar-width: 380px;
        }

        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 0; display: flex; height: 100vh; overflow: hidden; background: var(--bg-dark); color: white; }

        /* レイアウト設計 */
        #map { flex-grow: 1; height: 100%; position: relative; }
        
        #sidebar {
            width: var(--sidebar-width);
            background: #000;
            border-left: 1px solid #333;
            display: flex;
            flex-direction: column;
            padding: 20px;
            box-sizing: border-box;
            z-index: 10;
            overflow-y: auto;
        }

        /* UIコンポーネント */
        .header { margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 10px; }
        .controls { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        
        .btn {
            padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer;
            transition: opacity 0.2s; font-size: 14px; display: flex; align-items: center; justify-content: center;
        }
        .btn:disabled { opacity: 0.3; cursor: not-allowed; }
        .btn-plus { background: var(--primary-blue); color: white; }
        .btn-minus { background: var(--danger-red); color: white; }
        .btn-util { background: #333; color: white; }

        .search-box { margin-bottom: 20px; position: relative; }
        #addr-search { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #333; background: #111; color: white; box-sizing: border-box; }

        .query-container {
            background: #111; border: 1px solid #333; border-radius: 8px; padding: 15px; margin-top: auto;
        }
        #query-text {
            font-family: monospace; font-size: 12px; color: var(--primary-blue);
            word-break: break-all; margin-bottom: 10px; display: block; min-height: 60px;
        }
        
        .counter { font-size: 12px; text-align: right; color: #888; }
        .counter.limit-over { color: var(--danger-red); font-weight: bold; }

        /* リスト表示 */
        .circle-item {
            background: #1a1a1a; padding: 10px; border-radius: 6px; margin-bottom: 8px;
            display: flex; justify-content: space-between; align-items: center; border-left: 4px solid #333;
        }
        .circle-item.type-include { border-left-color: var(--primary-blue); }
        .circle-item.type-exclude { border-left-color: var(--danger-red); }

        /* デバッグ・警告モード */
        #debug-overlay {
            position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.8);
            padding: 10px; border-radius: 5px; font-size: 10px; pointer-events: none; visibility: hidden;
        }
        .dirty-warn { color: #ffad1f; font-size: 11px; margin-top: 5px; }

        /* レスポンシブ */
        @media (max-width: 800px) {
            body { flex-direction: column; }
            #sidebar { width: 100%; height: 40%; border-left: none; border-top: 1px solid #333; }
        }

        /* [AD/WIDGET SLOT] */
        .ad-placeholder { margin-top: 10px; font-size: 10px; color: #444; text-align: center; }
    </style>
</head>
<body>

<div id="map">
    <div id="debug-overlay">DEBUG: Active</div>
</div>

<div id="sidebar">
    <div class="header">
        <h2 style="margin:0; font-size: 1.2rem;">X Geo-Targeter <span style="font-size: 0.7rem; color: #888;">v2.0</span></h2>
    </div>

    <div class="search-box">
        <input type="text" id="addr-search" placeholder="地名を検索してジャンプ..." autocomplete="off">
    </div>

    <div class="controls">
        <button class="btn btn-plus" id="btn-add-inc">+ 追加 (0/4)</button>
        <button class="btn btn-minus" id="btn-add-exc">- 除外 (0/4)</button>
    </div>

    <div style="flex-grow: 1;">
        <div id="circle-list"></div>
        <div id="undo-redo" style="display: flex; gap: 5px; margin-top: 10px;">
            <button class="btn btn-util" onclick="app.undo()" style="flex:1">Undo</button>
            <button class="btn btn-util" onclick="app.redo()" style="flex:1">Redo</button>
        </div>
    </div>

    <div class="query-container">
        <strong style="font-size: 13px;">生成されたコマンド:</strong>
        <span id="query-text">geocode:31.5,34.7,100km</span>
        <div class="counter" id="char-counter">0 / 500</div>
        <button class="btn btn-plus" style="width:100%; margin-top:10px;" onclick="app.copyQuery()">コマンドをコピー</button>
        <button class="btn btn-util" style="width:100%; margin-top:5px; font-size: 11px;" onclick="app.exportJSON()">JSON保存</button>
        <div class="dirty-warn" id="dirty-msg"></div>
    </div>
    
    <div class="ad-placeholder">/* [AD SLOT] ここに広告ユニットを追加 */</div>
</div>

<script>
/**
 * X-Geo-Targeting Tool
 * * [設計方針]
 * 1. State-Driven: 円のデータ配列を基準に地図とリストを同期
 * 2. Performance: WebGLを使用し、不要なDOM更新を最小化
 * 3. Robustness: 小数点第5位での丸め、エラーハンドリング完備
 */

const CONFIG = {
    INITIAL_VIEW: [34.7818, 31.5], // Israel
    MAX_CIRCLES: 4,
    MAP_STYLE: 'https://tile.openstreetmap.jp/styles/osm-bright-ja/style.json', // 言語を日本語/英語に統一するためのタイル設定
    DECIMAL_PRECISION: 5
};

class GeoTargeter {
    constructor() {
        this.state = {
            circles: [],
            mode: null, // 'include' | 'exclude'
            isDirty: false
        };
        this.history = [];
        this.redoStack = [];
        this.map = null;
        this.init();
    }

    init() {
        // 地図の初期化
        this.map = new maplibregl.Map({
            container: 'map',
            style: CONFIG.MAP_STYLE,
            center: CONFIG.INITIAL_VIEW,
            zoom: 6,
            hash: true // URLパラメータでの位置保存
        });

        this.map.on('load', () => {
            this.setupMapLayers();
            this.bindEvents();
            this.loadFromStorage();
            console.log("App Initialized. Language set to Japanese/Standard via Tile.");
        });
    }

    setupMapLayers() {
        // 円の描画用ソース
        this.map.addSource('circles-source', {
            type: 'geojson',
            data: { type: 'FeatureCollection', features: [] }
        });

        // 追加エリアの描画
        this.map.addLayer({
            id: 'layer-include',
            type: 'fill',
            source: 'circles-source',
            paint: { 'fill-color': '#1d9bf0', 'fill-opacity': 0.3, 'fill-outline-color': '#1d9bf0' },
            filter: ['==', 'type', 'include']
        });

        // 除外エリアの描画
        this.map.addLayer({
            id: 'layer-exclude',
            type: 'fill',
            source: 'circles-source',
            paint: { 'fill-color': '#e0245e', 'fill-opacity': 0.3, 'fill-outline-color': '#e0245e' },
            filter: ['==', 'type', 'exclude']
        });
    }

    bindEvents() {
        // 地図クリックで円を追加
        this.map.on('click', (e) => {
            if (!this.state.mode) return;
            this.addCircle(e.lngLat.lat, e.lngLat.lng, 50, this.state.mode);
            this.setMode(null);
        });

        document.getElementById('btn-add-inc').onclick = () => this.setMode('include');
        document.getElementById('btn-add-exc').onclick = () => this.setMode('exclude');

        // 住所検索
        document.getElementById('addr-search').onkeydown = async (e) => {
            if (e.key === 'Enter') {
                const res = await fetch(`https://photon.komoot.io/api/?q=${encodeURIComponent(e.target.value)}&limit=1`);
                const data = await res.json();
                if (data.features.length > 0) {
                    const [lng, lat] = data.features[0].geometry.coordinates;
                    this.map.flyTo({ center: [lng, lat], zoom: 10 });
                }
            }
        };

        // 離脱警告
        window.onbeforeunload = (e) => {
            if (this.state.isDirty) return "変更が保存されていません。";
        };
    }

    setMode(mode) {
        this.state.mode = mode;
        this.map.getCanvas().style.cursor = mode ? 'crosshair' : '';
    }

    addCircle(lat, lng, radius, type) {
        const count = this.state.circles.filter(c => c.type === type).length;
        if (count >= CONFIG.MAX_CIRCLES) {
            alert(`最大${CONFIG.MAX_CIRCLES}個までです。`);
            return;
        }

        const id = Date.now().toString();
        this.saveHistory();
        this.state.circles.push({ id, lat, lng, radius, type, active: true });
        this.update();
    }

    updateCircle(id, newData) {
        this.state.circles = this.state.circles.map(c => c.id === id ? { ...c, ...newData } : c);
        this.update();
    }

    removeCircle(id) {
        this.saveHistory();
        this.state.circles = this.state.circles.filter(c => c.id !== id);
        this.update();
    }

    update() {
        this.state.isDirty = true;
        this.renderMap();
        this.renderList();
        this.updateQuery();
        this.saveToStorage();
        this.updateButtonStatus();
    }

    renderMap() {
        const features = this.state.circles.map(c => {
            const circle = turf.circle([c.lng, c.lat], c.radius, { units: 'kilometers' });
            circle.properties = { id: c.id, type: c.type };
            return circle;
        });
        this.map.getSource('circles-source').setData({ type: 'FeatureCollection', features });
    }

    renderList() {
        const list = document.getElementById('circle-list');
        list.innerHTML = '';
        this.state.circles.forEach(c => {
            const div = document.createElement('div');
            div.className = `circle-item type-${c.type}`;
            div.innerHTML = `
                <div style="font-size: 11px;">
                    <strong>${c.type.toUpperCase()}</strong>: ${c.radius}km<br>
                    <span style="color:#666">${c.lat.toFixed(3)}, ${c.lng.toFixed(3)}</span>
                </div>
                <div>
                    <input type="range" min="1" max="500" value="${c.radius}" 
                           oninput="app.updateCircle('${c.id}', {radius: parseInt(this.value)})">
                    <button class="btn btn-util" onclick="app.removeCircle('${c.id}')" style="padding:4px 8px; margin-left:5px;">×</button>
                </div>
            `;
            list.appendChild(div);
        });
    }

    updateQuery() {
        const queryParts = this.state.circles.map(c => {
            const prefix = c.type === 'include' ? '' : '-';
            return `${prefix}geocode:${c.lat.toFixed(CONFIG.DECIMAL_PRECISION)},${c.lng.toFixed(CONFIG.DECIMAL_PRECISION)},${c.radius}km`;
        });
        
        const fullQuery = queryParts.join(' ');
        document.getElementById('query-text').innerText = fullQuery || '(円を配置してください)';
        
        const count = fullQuery.length;
        const counterEl = document.getElementById('char-counter');
        counterEl.innerText = `${count} / 500 characters`;
        counterEl.className = count > 500 ? 'counter limit-over' : 'counter';
    }

    updateButtonStatus() {
        const incCount = this.state.circles.filter(c => c.type === 'include').length;
        const excCount = this.state.circles.filter(c => c.type === 'exclude').length;
        document.getElementById('btn-add-inc').innerText = `+ 追加 (${incCount}/${CONFIG.MAX_CIRCLES})`;
        document.getElementById('btn-add-exc').innerText = `- 除外 (${excCount}/${CONFIG.MAX_CIRCLES})`;
    }

    // --- ユーティリティ ---
    copyQuery() {
        const text = document.getElementById('query-text').innerText;
        navigator.clipboard.writeText(text);
        alert("X(Twitter)用コマンドをコピーしました");
    }

    saveToStorage() {
        localStorage.setItem('geo_target_state', JSON.stringify(this.state.circles));
        document.getElementById('dirty-msg').innerText = "✓ 自動保存済み";
    }

    loadFromStorage() {
        const saved = localStorage.getItem('geo_target_state');
        if (saved) {
            this.state.circles = JSON.parse(saved);
            this.update();
        }
    }

    exportJSON() {
        const blob = new Blob([JSON.stringify(this.state.circles, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `x-geo-config-${Date.now()}.json`;
        a.click();
    }

    saveHistory() {
        this.history.push(JSON.stringify(this.state.circles));
        if (this.history.length > 20) this.history.shift();
        this.redoStack = [];
    }

    undo() {
        if (this.history.length === 0) return;
        this.redoStack.push(JSON.stringify(this.state.circles));
        this.state.circles = JSON.parse(this.history.pop());
        this.update();
    }

    redo() {
        if (this.redoStack.length === 0) return;
        this.history.push(JSON.stringify(this.state.circles));
        this.state.circles = JSON.parse(this.redoStack.pop());
        this.update();
    }
}

// アプリ起動
const app = new GeoTargeter();
</script>

</body>
</html>
